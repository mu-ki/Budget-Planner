@model BudgetPlanner.Web.Models.ReserveAccountViewModel
@{
    ViewData["Title"] = "Reserve: " + Model.ExpenseDescription;
}

<h1>@Model.ExpenseDescription</h1>
@if (Model.StartDate.HasValue || Model.TenureEnd.HasValue)
{
    <p class="text-muted">
        @if (Model.StartDate.HasValue) { <span>Start: @Model.StartDate.Value.ToString("MMM yyyy")</span> }
        @if (Model.StartDate.HasValue && Model.TenureEnd.HasValue) { <span> · </span> }
        @if (Model.TenureEnd.HasValue) { <span>End: @Model.TenureEnd.Value.ToString("MMM yyyy")</span> }
    </p>
}

<div class="row mb-4">
    <div class="col-md-3">
        <div class="card border-success">
            <div class="card-body">
                <h6>Total Saved</h6>
                <h4 class="text-success">@Model.TotalAllocated.ToString("C")</h4>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-danger">
            <div class="card-body">
                <h6>Total Paid</h6>
                <h4 class="text-danger">@Model.TotalPaid.ToString("C")</h4>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-primary">
            <div class="card-body">
                <h6>Balance</h6>
                <h4 class="text-primary">@Model.Balance.ToString("C")</h4>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-info">
            <div class="card-body">
                <h6>Installment</h6>
                <h4 class="text-info">@Model.InstallmentAmount.ToString("C")</h4>
                <small>@(Model.ExpenseType == BudgetPlanner.Web.Models.ExpenseType.Monthly ? "Monthly" : Model.ExpenseType == BudgetPlanner.Web.Models.ExpenseType.Chit ? $"Chit ({Model.IntervalMonths} months)" : Model.IntervalMonths == 12 ? "Yearly" : $"Every {Model.IntervalMonths} months")</small>
            </div>
        </div>
    </div>
</div>

<div class="mb-3">
    <a asp-action="AddAllocation" asp-route-reserveAccountId="@Model.Id" asp-route-year="@DateTime.Now.Year" asp-route-month="@DateTime.Now.Month" class="btn btn-success">Record Allocation (Save)</a>
    <a asp-action="AddPayment" asp-route-reserveAccountId="@Model.Id" class="btn btn-danger">Record Payment</a>
    <a asp-action="EditReserve" asp-route-id="@Model.Id" class="btn btn-outline-secondary">Edit Start/End Date</a>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Allocations (Saved)</h5>
            </div>
            <div class="card-body p-0">
                @if (Model.Allocations.Any())
                {
                    <table class="table table-sm mb-0">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var a in Model.Allocations.Take(20))
                            {
                                <tr>
                                    <td>@a.AllocationDate.ToString("MMM yyyy")</td>
                                    <td class="text-success">@a.Amount.ToString("C")</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                    @if (Model.Allocations.Count > 20)
                    {
                        <p class="p-2 mb-0 text-muted small">Showing last 20 of @Model.Allocations.Count</p>
                    }
                }
                else
                {
                    <p class="p-3 mb-0 text-muted">No allocations yet.</p>
                }
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Payments (Paid Out)</h5>
            </div>
            <div class="card-body p-0">
                @if (Model.Payments.Any())
                {
                    <table class="table table-sm mb-0">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Amount</th>
                                <th>Notes</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var p in Model.Payments.Take(20))
                            {
                                <tr>
                                    <td>@p.PaymentDate.ToString("dd MMM yyyy")</td>
                                    <td class="text-danger">@p.Amount.ToString("C")</td>
                                    <td class="small">@(p.Notes ?? "-")</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                    @if (Model.Payments.Count > 20)
                    {
                        <p class="p-2 mb-0 text-muted small">Showing last 20 of @Model.Payments.Count</p>
                    }
                }
                else
                {
                    <p class="p-3 mb-0 text-muted">No payments yet.</p>
                }
            </div>
        </div>
    </div>
</div>

<p class="mt-4">
    <a asp-action="ReserveAccounts" class="btn btn-secondary">← Back to Reserve Accounts</a>
</p>
